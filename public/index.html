<!DOCTYPE html>
<html>
	<head>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
		<link
			rel="stylesheet"
			type="text/css"
			href="https://jsxgraph.org/distrib/jsxgraph.css"
		/>
		<script
			type="text/javascript"
			src="https://jsxgraph.org/distrib/jsxgraphcore.js"
		></script>
	</head>

	<body>
		<title>FEM 2D Truss</title>
		<h1>FEM Truss2D Solver</h1>
		<div>
			<div id="app">
				<label for="fname">h:</label>
				<input type="text" v-model="h" /><br /><br />
				<label for="fname">dLx:</label>
				<input type="text" v-model="dLx" /><br /><br />
				<label for="fname">N:</label>
				<input type="text" v-model="N" /><br /><br />
				<input type="submit" value="Submit" @click="Solve" /><br /><br />
			</div>
			<div id="sample" class="jxgbox" style="width: 260px; height: 160px"></div>
			<div id="jxgbox" class="jxgbox" style="width: 500px; height: 300px"></div>
			<div id="solution" style="width: 700px; height: 500px">
				<h2>Results</h2>
				<p1 id="results"></p1>
			</div>
		</div>

		<script>
			var brd = JXG.JSXGraph.initBoard('sample', {
				boundingbox: [-1, 3, 3, -1],
				keepaspectratio: true,
				showCopyright: false,
				showNavigation: false,
				axis: false,
			});
			drawSegment(brd, 1, 0, 2, 2, 'brown');
			drawSegment(brd, 2, 2, 3, 0, 'brown');
			drawSegment(brd, 3, 0, 1, 0, 'brown');
			drawSegment(brd, 0.8, 0, 0.8, 2, 'purple', 'h');
			drawSegment(brd, 1, -0.6, 3, -0.6, 'purple', 'dLx');
			var sgmnt = brd.create('text', [3, 1.5, 'N : span number'], {
				fontSize: 10,
			});

			function drawSegment(board, x1, y1, x2, y2, color, name) {
				var f = 1.0;
				var segment = board.create(
					'segment',
					[
						[x1 * f, y1 * f],
						[x2 * f, y2 * f],
					],
					{
						strokeColor: color || '#0000ff',
						withLabel: true,
						name: name || '',
						label: { position: 'left', parse: true },
					}
				);
				return segment;
			}

			// function drawLine(paper, x1, y1, x2, y2) {
			// 	var f = 70;
			// 	var line = paper.path([
			// 		'M',
			// 		x1 * f,
			// 		paper.height - f * y1 - 70,
			// 		'L',
			// 		f * x2,
			// 		paper.height - f * y2 - 70,
			// 	]);
			// 	return line;
			// }

			var app = new Vue({
				el: '#app',
				data: function () {
					return {
						h: 1.5,
						dLx: 1.0,
						N: 3,
						X: [1, 4, 5, 7],
						Y: [5, -3, 5, 7],
						solution: null,
					};
					elements = null;
					nodes = null;
					this.elements = res.data.payload.elements;
					this.nodes = res.data.payload.nodes;
				},

				methods: {
					Solve: function () {
						var { h, dLx, N } = this;

						axios.post('/truss2D/solve', { h, dLx, N }).then((res) => {
							this.solution = res.data.payload;
							// var paper = Raphael(this.$refs.paper, 300, 200);
							// paper.setViewBox(0, 0, 300, 200);
							// paper.canvas.style.backgroundColor = '#eee';
							var board = JXG.JSXGraph.initBoard('jxgbox', {
								boundingbox: [-0.1 * dLx * N, 1.3 * h, 1.1 * dLx * N, -0.5 * h],
								keepaspectratio: true,
								showCopyright: false,
								showNavigation: false,
								axis: true,
								drag: {
									enabled: true, // Allow dragging
								},
							});

							var elements = res.data.payload.elements;
							var nodes = res.data.payload.nodes;

							console.log(nodes);
							// var line1 = board.create('line', [
							// 	[2, 1],
							// 	[-3, 2],
							// ]);
							var elL = [];
							var elR = [];

							Object.keys(elements).forEach((id) => {
								var elm = elements[id];
								var n1 = nodes[elm.n1];
								var n2 = nodes[elm.n2];
								var X1 = parseFloat(n1.X);
								var Y1 = parseFloat(n1.Y);
								var X2 = parseFloat(n2.X);
								var Y2 = parseFloat(n2.Y);
								drawSegment(board, X1, Y1, X2, Y2, '#aaaaaa');
							});
							Object.keys(elements).forEach((id) => {
								var elm = elements[id];
								var n1 = nodes[elm.n1];
								var n2 = nodes[elm.n2];
								var X1 = parseFloat(n1.X) + n1.u[0];
								var Y1 = parseFloat(n1.Y) + n1.u[1];
								var X2 = parseFloat(n2.X) + n2.u[0];
								var Y2 = parseFloat(n2.Y) + n2.u[1];
								// results
								var strL = parseFloat(n1.u);
								var strR = parseFloat(n2.u);
								// // str = (str - (str % 1000)) / 1000;
								elL.push(strL);
								elR.push(strR);

								drawSegment(board, X1, Y1, X2, Y2);
								// result.textContent = elements.n1;
							});
							const result = document.getElementById('results');
							console.log(elL);
							console.log(elR);
							result.textContent =
								'Left side node displacement:' +
								elL +
								' ' +
								' ' +
								'Right side node displacement:' +
								elR;
						});
					},
				},

				watch: {
					h: function (n, o) {
						console.log('h:', n);
					},
				},
			});

			/*
			var line = paper.path("M160 80 L190 20 220 80 160 80");
			var line = paper.path("M130 20 L190 20")*/
		</script>
		<link rel="stylesheet" type="text/css" href="index.css" />
	</body>
</html>
